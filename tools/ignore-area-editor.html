<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firescrew - IgnoreAreasClasses åŒºåŸŸç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .controls {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #9cdcfe;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"],
        select {
            width: 100%;
            padding: 8px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #d4d4d4;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #1177bb;
        }

        button.secondary {
            background: #3c3c3c;
        }

        button.secondary:hover {
            background: #505050;
        }

        button.danger {
            background: #d13438;
        }

        button.danger:hover {
            background: #e13438;
        }

        .canvas-container {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: auto;
        }

        canvas {
            border: 2px solid #555;
            cursor: crosshair;
            display: block;
            max-width: 100%;
        }

        .output {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
        }

        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #555;
            overflow-x: auto;
            font-size: 13px;
            color: #ce9178;
        }

        .class-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .class-tag {
            padding: 6px 12px;
            background: #3c3c3c;
            border: 2px solid #555;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .class-tag.selected {
            background: #0e639c;
            border-color: #1177bb;
        }

        .areas-list {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #555;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .area-item {
            background: #252526;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 3px solid #4ec9b0;
        }

        .area-item:hover {
            background: #2d2d30;
        }

        .area-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .area-item-classes {
            color: #4ec9b0;
            font-weight: bold;
        }

        .area-item-buttons {
            display: flex;
            gap: 5px;
        }

        .area-item button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .info {
            background: #264f78;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .custom-class-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .custom-class-input input {
            flex: 1;
        }

        .drawing-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-button {
            flex: 1;
            padding: 10px;
            background: #3c3c3c;
            border: 2px solid #555;
            color: #d4d4d4;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .mode-button.active {
            background: #0e639c;
            border-color: #1177bb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Firescrew - IgnoreAreasClasses åŒºåŸŸç¼–è¾‘å™¨</h1>

        <div class="controls">
            <div class="info">
                <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>
                1. åŠ è½½è§†é¢‘æµæˆªå›¾æˆ–ä¸Šä¼ å›¾ç‰‡
                2. é€‰æ‹©è¦å¿½ç•¥çš„æ£€æµ‹ç±»åˆ«
                3. åœ¨ç”»å¸ƒä¸Šç»˜åˆ¶çŸ©å½¢åŒºåŸŸï¼ˆæ‹–æ‹½ç»˜åˆ¶ï¼‰
                4. ç‚¹å‡»"å®Œæˆå½“å‰åŒºåŸŸ"ä¿å­˜
                5. å¤åˆ¶ç”Ÿæˆçš„JSONé…ç½®åˆ° config.json çš„ ignoreAreasClasses å­—æ®µ
                <br><br>
                <strong>åæ ‡æ ¼å¼ï¼š</strong> coordinates = "top,bottom,left,right" (4ä¸ªæ•´æ•°)
            </div>

            <div class="control-group">
                <label>è§†é¢‘æµåœ°å€ (ä»ç›¸æœºæˆªå›¾)</label>
                <input type="text" id="streamUrl" placeholder="http://localhost:8042 æˆ–è¾“å…¥è§†é¢‘æµåœ°å€">
                <button onclick="loadFromStream()" style="margin-top: 10px;">åŠ è½½è§†é¢‘æµæˆªå›¾</button>
            </div>

            <div class="control-group">
                <label>æˆ–ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</label>
                <input type="file" id="imageFile" accept="image/*" onchange="loadFromFile()">
            </div>

            <div class="control-group" style="display: none;">
                <label>ç»˜åˆ¶æ¨¡å¼</label>
                <div class="drawing-mode">
                    <button class="mode-button active" onclick="setDrawingMode('rectangle')">
                        çŸ©å½¢æ¨¡å¼ï¼ˆä»…æ”¯æŒï¼‰
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label>é€‰æ‹©è¦å¿½ç•¥çš„æ£€æµ‹ç±»åˆ« (å¯å¤šé€‰)</label>
                <div class="class-selector" id="classSelector">
                    <!-- å¸¸ç”¨ç±»åˆ« -->
                </div>
                <div class="custom-class-input">
                    <input type="text" id="customClass" placeholder="è¾“å…¥è‡ªå®šä¹‰ç±»åˆ«">
                    <button onclick="addCustomClass()">æ·»åŠ </button>
                </div>
            </div>

            <div class="button-group">
                <button onclick="finishCurrentArea()">å®Œæˆå½“å‰åŒºåŸŸ</button>
                <button class="secondary" onclick="clearCurrentDrawing()">æ¸…é™¤å½“å‰ç»˜åˆ¶</button>
                <button class="danger" onclick="clearAllAreas()">æ¸…é™¤æ‰€æœ‰åŒºåŸŸ</button>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="output">
            <h2 style="margin-bottom: 15px; color: #4ec9b0;">å·²ç»˜åˆ¶çš„åŒºåŸŸ</h2>
            <div class="areas-list" id="areasList"></div>

            <h2 style="margin-bottom: 15px; color: #4ec9b0;">ç”Ÿæˆçš„é…ç½®</h2>
            <button onclick="copyToClipboard()" style="margin-bottom: 10px;">ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            <pre id="output">[]</pre>
        </div>
    </div>

    <script>
        // å¸¸ç”¨çš„ COCO ç±»åˆ«
        const commonClasses = [
            'person', 'car', 'truck', 'bus', 'motorcycle', 'bicycle',
            'dog', 'cat', 'bird', 'chair', 'bottle', 'cup'
        ];

        let canvas, ctx;
        let imageLoaded = false;
        let currentImage = null;
        let areas = [];
        let currentPoints = [];
        let selectedClasses = new Set();
        let isDrawing = false;
        let drawingMode = 'rectangle'; // 'rectangle' or 'polygon'
        let startPoint = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            // åˆå§‹åŒ–ç±»åˆ«é€‰æ‹©å™¨
            initClassSelector();

            // æ·»åŠ ç”»å¸ƒäº‹ä»¶ç›‘å¬
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('dblclick', handleDoubleClick);
        };

        function initClassSelector() {
            const selector = document.getElementById('classSelector');
            selector.innerHTML = '';

            commonClasses.forEach(cls => {
                const tag = document.createElement('div');
                tag.className = 'class-tag';
                tag.textContent = cls;
                tag.onclick = () => toggleClass(cls, tag);
                selector.appendChild(tag);
            });
        }

        function toggleClass(className, element) {
            if (selectedClasses.has(className)) {
                selectedClasses.delete(className);
                element.classList.remove('selected');
            } else {
                selectedClasses.add(className);
                element.classList.add('selected');
            }
        }

        function addCustomClass() {
            const input = document.getElementById('customClass');
            const className = input.value.trim();

            if (!className) return;

            if (!commonClasses.includes(className)) {
                commonClasses.push(className);
                initClassSelector();
            }

            // è‡ªåŠ¨é€‰ä¸­
            selectedClasses.add(className);
            const tags = document.querySelectorAll('.class-tag');
            tags.forEach(tag => {
                if (tag.textContent === className) {
                    tag.classList.add('selected');
                }
            });

            input.value = '';
        }

        function setDrawingMode(mode) {
            drawingMode = mode;
            const buttons = document.querySelectorAll('.mode-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            clearCurrentDrawing();
        }

        function loadFromStream() {
            const url = document.getElementById('streamUrl').value.trim();
            if (!url) {
                alert('è¯·è¾“å…¥è§†é¢‘æµåœ°å€');
                return;
            }

            // å°è¯•åŠ è½½è§†é¢‘æµçš„å½“å‰å¸§
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                setupCanvas(this);
            };
            img.onerror = function() {
                alert('æ— æ³•åŠ è½½è§†é¢‘æµæˆªå›¾ï¼Œè¯·ç¡®ä¿åœ°å€æ­£ç¡®ä¸”æœåŠ¡æ­£åœ¨è¿è¡Œ');
            };
            img.src = url;
        }

        function loadFromFile() {
            const file = document.getElementById('imageFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    setupCanvas(this);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function setupCanvas(img) {
            currentImage = img;
            canvas.width = img.width;
            canvas.height = img.height;
            imageLoaded = true;
            redraw();
        }

        function handleMouseDown(e) {
            if (!imageLoaded) return;

            const rect = canvas.getBoundingClientRect();
            const x = Math.round((e.clientX - rect.left) * (canvas.width / rect.width));
            const y = Math.round((e.clientY - rect.top) * (canvas.height / rect.height));

            if (drawingMode === 'rectangle') {
                isDrawing = true;
                startPoint = {x, y};
                currentPoints = [startPoint];
            } else if (drawingMode === 'polygon') {
                currentPoints.push({x, y});
                redraw();
            }
        }

        function handleMouseMove(e) {
            if (!imageLoaded) return;

            if (drawingMode === 'rectangle' && isDrawing && startPoint) {
                const rect = canvas.getBoundingClientRect();
                const x = Math.round((e.clientX - rect.left) * (canvas.width / rect.width));
                const y = Math.round((e.clientY - rect.top) * (canvas.height / rect.height));

                currentPoints = [
                    startPoint,
                    {x: x, y: startPoint.y},
                    {x: x, y: y},
                    {x: startPoint.x, y: y}
                ];

                redraw();
            } else if (drawingMode === 'polygon' && currentPoints.length > 0) {
                // æ˜¾ç¤ºé¢„è§ˆçº¿
                const rect = canvas.getBoundingClientRect();
                const x = Math.round((e.clientX - rect.left) * (canvas.width / rect.width));
                const y = Math.round((e.clientY - rect.top) * (canvas.height / rect.height));

                redraw();

                // ç»˜åˆ¶é¢„è§ˆçº¿
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(currentPoints[currentPoints.length - 1].x, currentPoints[currentPoints.length - 1].y);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function handleMouseUp(e) {
            if (drawingMode === 'rectangle' && isDrawing) {
                isDrawing = false;
                if (currentPoints.length === 4) {
                    // è‡ªåŠ¨å®ŒæˆçŸ©å½¢
                    finishCurrentArea();
                }
            }
        }

        function handleDoubleClick(e) {
            if (drawingMode === 'polygon' && currentPoints.length >= 3) {
                finishCurrentArea();
            }
        }

        function redraw() {
            if (!currentImage) return;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶å›¾ç‰‡
            ctx.drawImage(currentImage, 0, 0);

            // ç»˜åˆ¶å·²ä¿å­˜çš„åŒºåŸŸ
            areas.forEach((area, index) => {
                drawPolygon(area.points, `hsl(${index * 137.5}, 70%, 50%)`, true);
            });

            // ç»˜åˆ¶å½“å‰æ­£åœ¨ç»˜åˆ¶çš„åŒºåŸŸ
            if (currentPoints.length > 0) {
                drawPolygon(currentPoints, 'rgba(255, 255, 0, 0.7)', false);
            }
        }

        function drawPolygon(points, color, filled) {
            if (points.length === 0) return;

            ctx.strokeStyle = color;
            ctx.fillStyle = color.replace(')', ', 0.2)').replace('rgb', 'rgba').replace('hsl', 'hsla');
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);

            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }

            if (filled) {
                ctx.closePath();
                ctx.fill();
            }

            ctx.stroke();

            // ç»˜åˆ¶é¡¶ç‚¹
            points.forEach(point => {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function finishCurrentArea() {
            if (currentPoints.length < 2) {
                alert('è‡³å°‘éœ€è¦2ä¸ªç‚¹æ‰èƒ½å½¢æˆåŒºåŸŸ');
                return;
            }

            if (selectedClasses.size === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦å¿½ç•¥çš„æ£€æµ‹ç±»åˆ«');
                return;
            }

            // è®¡ç®—è¾¹ç•Œæ¡†
            const xs = currentPoints.map(p => p.x);
            const ys = currentPoints.map(p => p.y);
            const left = Math.min(...xs);
            const right = Math.max(...xs);
            const top = Math.min(...ys);
            const bottom = Math.max(...ys);

            // ç”Ÿæˆ coordinates å­—ç¬¦ä¸²ï¼šæ ¼å¼ä¸º "top,bottom,left,right"
            const coordinates = `${top},${bottom},${left},${right}`;

            // ä¿å­˜åŒºåŸŸï¼ˆä¿å­˜å®Œæ•´çš„çŸ©å½¢ç”¨äºæ˜¾ç¤ºï¼‰
            areas.push({
                class: Array.from(selectedClasses),
                coordinates: coordinates,
                top: top,
                bottom: bottom,
                left: left,
                right: right,
                points: [
                    {x: left, y: top},
                    {x: right, y: top},
                    {x: right, y: bottom},
                    {x: left, y: bottom}
                ]
            });

            // æ¸…é™¤å½“å‰ç»˜åˆ¶
            currentPoints = [];
            startPoint = null;
            isDrawing = false;

            // é‡ç»˜å¹¶æ›´æ–°è¾“å‡º
            redraw();
            updateOutput();
        }

        function clearCurrentDrawing() {
            currentPoints = [];
            startPoint = null;
            isDrawing = false;
            redraw();
        }

        function clearAllAreas() {
            if (areas.length === 0) return;

            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å·²ç»˜åˆ¶çš„åŒºåŸŸå—ï¼Ÿ')) {
                areas = [];
                redraw();
                updateOutput();
            }
        }

        function deleteArea(index) {
            areas.splice(index, 1);
            redraw();
            updateOutput();
        }

        function updateOutput() {
            // ç”ŸæˆJSONè¾“å‡º - åªéœ€è¦ class å’Œ coordinates å­—æ®µ
            const output = areas.map(area => ({
                class: area.class,
                coordinates: area.coordinates
            }));

            document.getElementById('output').textContent = JSON.stringify(output, null, 4);

            // æ›´æ–°åŒºåŸŸåˆ—è¡¨
            updateAreasList();
        }

        function updateAreasList() {
            const list = document.getElementById('areasList');
            list.innerHTML = '';

            if (areas.length === 0) {
                list.innerHTML = '<div style="color: #858585; text-align: center;">æš‚æ— ç»˜åˆ¶åŒºåŸŸ</div>';
                return;
            }

            areas.forEach((area, index) => {
                const item = document.createElement('div');
                item.className = 'area-item';
                item.innerHTML = `
                    <div class="area-item-header">
                        <span class="area-item-classes">åŒºåŸŸ ${index + 1}: ${area.class.join(', ')}</span>
                        <div class="area-item-buttons">
                            <button class="danger" onclick="deleteArea(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #858585; margin-top: 5px;">
                        åæ ‡: ${area.coordinates.substring(0, 50)}${area.coordinates.length > 50 ? '...' : ''}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function copyToClipboard() {
            const output = document.getElementById('output').textContent;
            navigator.clipboard.writeText(output).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }
    </script>
</body>
</html>
